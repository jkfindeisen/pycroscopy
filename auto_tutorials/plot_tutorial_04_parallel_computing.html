

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial 4: Parallel Computing &mdash; pycroscopy 0.59.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="pycroscopy 0.59.2 documentation" href="../index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> pycroscopy
          

          
          </a>

          
            
            
              <div class="version">
                0.59.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">Pycroscopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">What’s New</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_format.html">Pycroscopy Data and File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../papers_conferences.html">Papers / Conferences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html">Examples &amp; Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html#scientific-data-analysis">Scientific Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html#developer-tutorials">Developer Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html#user-tutorials">User Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pycroscopy</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Tutorial 4: Parallel Computing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/auto_tutorials/plot_tutorial_04_parallel_computing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial-4-parallel-computing">
<span id="sphx-glr-auto-tutorials-plot-tutorial-04-parallel-computing-py"></span><h1>Tutorial 4: Parallel Computing<a class="headerlink" href="#tutorial-4-parallel-computing" title="Permalink to this headline">¶</a></h1>
<p><strong>Suhas Somnath, Chris R. Smith</strong></p>
<p>9/8/2017</p>
<p>This set of tutorials will serve as examples for developing end-to-end workflows for and using pycroscopy.</p>
<p><strong>In this example, we will learn how to compute using all available cores on a computer.</strong> Note, that this is
applicable only for a single CPU. Please refer to another advanced example for multi-CPU computing.</p>
<p>Quite often, we need to perform the same operation on every single component in our data. One of the most popular
examples is functional fitting applied to spectra collected at each location on a grid. While, the operation itself
may not take very long, computing this operation thousands of times, once per location, using a single CPU core can
take a long time to complete. Most personal computers today come with at least two cores, and in many cases, each of
these cores is represented via two logical cores, thereby summing to a total of at least four cores. Thus, it is
prudent to make use of these unused cores whenever possible. Fortunately, there are a few python packages that
facilitate the efficient use of all CPU cores with minimal modifications to the existing code.</p>
<p><strong>Here, we show how one can fit the thousands of spectra, one at each location, using multiple CPU cores.</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Ensure python 3 compatibility:</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="c1"># The package for accessing files in directories, etc.:</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Warning package in case something goes wrong</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="c1"># Package for downloading online files:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># This package is not part of anaconda and may need to be installed.</span>
    <span class="kn">import</span> <span class="nn">wget</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;wget not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;wget&#39;</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">wget</span>

<span class="c1"># The mathematical computation package:</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c1"># The package used for creating and manipulating HDF5 files:</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="c1"># Packages for plotting:</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="c1"># Parallel computation library:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">joblib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;joblib not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;joblib&#39;</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">joblib</span>

<span class="c1"># Timing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Finally import pycroscopy for certain scientific analysis:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pycroscopy</span> <span class="kn">as</span> <span class="nn">px</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;pycroscopy not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;pycroscopy&#39;</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">pycroscopy</span> <span class="kn">as</span> <span class="nn">px</span>
</pre></div>
</div>
<div class="section" id="load-the-dataset">
<h2>Load the dataset<a class="headerlink" href="#load-the-dataset" title="Permalink to this headline">¶</a></h2>
<p>For this example, we will be working with a Band Excitation Piezoresponse Force Microscopy (BE-PFM) imaging dataset
acquired from advanced atomic force microscopes. In this dataset, a spectra was collected for each position in a two
dimensional grid of spatial locations. Thus, this is a three dimensional dataset that has been flattened to a two
dimensional matrix in accordance with the pycroscopy data format.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># download the raw data file from Github:</span>
<span class="n">h5_path</span> <span class="o">=</span> <span class="s1">&#39;temp.h5&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/pycroscopy/pycroscopy/master/data/BELine_0004.h5&#39;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">h5_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h5_path</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">h5_path</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Open the file in read-only mode</span>
<span class="n">h5_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">h5_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="c1"># Get handles to the the raw data along with other datasets and datagroups that contain necessary parameters</span>
<span class="n">h5_meas_grp</span> <span class="o">=</span> <span class="n">h5_file</span><span class="p">[</span><span class="s1">&#39;Measurement_000&#39;</span><span class="p">]</span>

<span class="c1"># Getting a reference to the main dataset:</span>
<span class="n">h5_main</span> <span class="o">=</span> <span class="n">h5_meas_grp</span><span class="p">[</span><span class="s1">&#39;Channel_000/Raw_Data&#39;</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The main dataset:</span><span class="se">\n</span><span class="s1">------------------------------------&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">h5_main</span><span class="p">)</span>

<span class="n">num_rows</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">h5_meas_grp</span><span class="p">,</span> <span class="s1">&#39;grid_num_rows&#39;</span><span class="p">)</span>
<span class="n">num_cols</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">h5_meas_grp</span><span class="p">,</span> <span class="s1">&#39;grid_num_cols&#39;</span><span class="p">)</span>

<span class="c1"># Extracting the X axis - vector of frequencies</span>
<span class="n">h5_spec_vals</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getAuxData</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">freq_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">h5_spec_vals</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1E-3</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">main</span> <span class="n">dataset</span><span class="p">:</span>
<span class="o">------------------------------------</span>
<span class="o">&lt;</span><span class="n">HDF5</span> <span class="n">dataset</span> <span class="s2">&quot;Raw_Data&quot;</span><span class="p">:</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">16384</span><span class="p">,</span> <span class="mi">119</span><span class="p">),</span> <span class="nb">type</span> <span class="s2">&quot;&lt;c8&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="visualize-the-data">
<h2>Visualize the data<a class="headerlink" href="#visualize-the-data" title="Permalink to this headline">¶</a></h2>
<p>Visualize the spectra at each of the locations using the interactive jupyter widgets below:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">be_viz_utils</span><span class="o">.</span><span class="n">jupyter_visualize_be_spectrograms</span><span class="p">(</span><span class="n">h5_main</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_tutorial_04_parallel_computing_0011.png" class="align-center" src="../_images/sphx_glr_plot_tutorial_04_parallel_computing_0011.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="n">No</span> <span class="n">position</span> <span class="n">datasets</span> <span class="n">found</span> <span class="k">as</span> <span class="n">attributes</span> <span class="n">of</span> <span class="o">/</span><span class="n">Measurement_000</span><span class="o">/</span><span class="n">Channel_000</span><span class="o">/</span><span class="n">Spectroscopic_Values</span>
<span class="n">HBox</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">(</span><span class="n">Text</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;temp.h5&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Output Filename:&#39;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;50%&#39;</span><span class="p">),</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;Type something&#39;</span><span class="p">),</span> <span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Save figure&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">ButtonStyle</span><span class="p">())))</span>
<span class="n">interactive</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">(</span><span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">118</span><span class="p">),</span> <span class="n">Output</span><span class="p">()),</span> <span class="n">_dom_classes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;widget-interact&#39;</span><span class="p">,))</span>
</pre></div>
</div>
</div>
<div class="section" id="the-operation">
<h2>The operation<a class="headerlink" href="#the-operation" title="Permalink to this headline">¶</a></h2>
<p>We will be computing the parameters that would best describe these complex-valued spectra using a simple harmonic
oscillator model in the functions below. These functions have been taken from the BESHOFit submodule available in
pycroscopy.analysis.</p>
<p>The specifics of the functions are not of interest for this example. Instead, all we need to know
is that we need to apply a function (SHOestimateGuess in our case) on each element in our dataset.
the functions below</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">SHOfunc</span><span class="p">(</span><span class="n">parms</span><span class="p">,</span> <span class="n">w_vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the SHO response over the given frequency band</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    parms : list or tuple</span>
<span class="sd">        SHO parameters=(Amplitude, frequency ,Quality factor, phase)</span>
<span class="sd">    w_vec : 1D numpy array</span>
<span class="sd">        Vector of frequency values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span> <span class="o">*</span> <span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span>         <span class="p">(</span><span class="n">w_vec</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">w_vec</span> <span class="o">*</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">SHOestimateGuess</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">,</span> <span class="n">w_vec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">num_points</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates good initial guesses for fitting</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    resp_vec : 1D complex numpy array or list</span>
<span class="sd">        BE response vector as a function of frequency</span>
<span class="sd">    w_vec : 1D numpy array or list, Optional</span>
<span class="sd">        Vector of BE frequencies</span>
<span class="sd">    num_points : (Optional) unsigned int</span>
<span class="sd">        Quality factor of the SHO peak</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    retval : tuple</span>
<span class="sd">        SHO fit parameters arranged as amplitude, frequency, quality factor, phase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">w_vec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Some default value</span>
        <span class="n">w_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">300E+3</span><span class="p">,</span> <span class="mf">350E+3</span><span class="p">,</span> <span class="n">resp_vec</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">a_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">e_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_points</span><span class="p">):</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="n">w_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="n">c1</span><span class="p">]]</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="n">w_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="n">c2</span><span class="p">]]</span>
            <span class="n">X1</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="n">c1</span><span class="p">]])</span>
            <span class="n">X2</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="n">c2</span><span class="p">]])</span>
            <span class="n">Y1</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="n">c1</span><span class="p">]])</span>
            <span class="n">Y2</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="n">c2</span><span class="p">]])</span>

            <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="p">(</span><span class="n">X1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">X1</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">Y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y1</span> <span class="o">-</span> <span class="n">Y2</span><span class="p">))</span> <span class="o">+</span> <span class="n">w2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">X1</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">X2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">Y1</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">Y2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">w1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">*</span> <span class="p">(</span><span class="n">X1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">X1</span> <span class="o">*</span> <span class="p">(</span><span class="n">X2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="n">denom</span>
                <span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">w1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">*</span> <span class="p">(</span><span class="n">X1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">Y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">X2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="n">denom</span>
                <span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">w1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">X2</span> <span class="o">*</span> <span class="n">Y1</span> <span class="o">-</span> <span class="n">X1</span> <span class="o">*</span> <span class="n">Y2</span><span class="p">))</span> <span class="o">/</span> <span class="n">denom</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">X1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
                     <span class="n">w1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w2</span> <span class="o">*</span> <span class="p">(</span><span class="n">X1</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">Y1</span> <span class="o">*</span> <span class="n">Y2</span><span class="p">)</span> <span class="o">-</span>
                     <span class="n">w1</span> <span class="o">*</span> <span class="n">w2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">X1</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">Y1</span> <span class="o">*</span> <span class="n">Y2</span><span class="p">)</span> <span class="o">+</span>
                     <span class="n">w2</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">X2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Y2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">denom</span>

                <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a_mat</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">a_mat</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>

                    <span class="n">A_fit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">d</span>
                    <span class="n">w0_fit</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">Q_fit</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span>
                    <span class="n">phi_fit</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">)</span>

                    <span class="n">H_fit</span> <span class="o">=</span> <span class="n">A_fit</span> <span class="o">*</span> <span class="n">w0_fit</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span> <span class="o">*</span> <span class="n">phi_fit</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="n">w_vec</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">w_vec</span> <span class="o">*</span> <span class="n">w0_fit</span> <span class="o">/</span> <span class="n">Q_fit</span> <span class="o">-</span> <span class="n">w0_fit</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="n">e_vec</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">e_vec</span><span class="p">,</span>
                                   <span class="nb">sum</span><span class="p">((</span><span class="n">real</span><span class="p">(</span><span class="n">H_fit</span><span class="p">)</span> <span class="o">-</span> <span class="n">real</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                   <span class="nb">sum</span><span class="p">((</span><span class="n">imag</span><span class="p">(</span><span class="n">H_fit</span><span class="p">)</span> <span class="o">-</span> <span class="n">imag</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">a_mat</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a_mat</span> <span class="o">=</span> <span class="n">a_mat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">weight_vec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">e_vec</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span>
        <span class="n">w_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight_vec</span><span class="p">)</span>

        <span class="n">a_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight_vec</span> <span class="o">*</span> <span class="n">a_mat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">w_sum</span>
        <span class="n">b_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight_vec</span> <span class="o">*</span> <span class="n">a_mat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">w_sum</span>
        <span class="n">c_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight_vec</span> <span class="o">*</span> <span class="n">a_mat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">w_sum</span>
        <span class="n">d_w</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight_vec</span> <span class="o">*</span> <span class="n">a_mat</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">w_sum</span>

        <span class="n">A_fit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a_w</span> <span class="o">+</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">b_w</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_w</span>
        <span class="n">w0_fit</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d_w</span><span class="p">)</span>
        <span class="n">Q_fit</span> <span class="o">=</span> <span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d_w</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_w</span>
        <span class="n">phi_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">b_w</span><span class="p">,</span> <span class="o">-</span><span class="n">a_w</span><span class="p">)</span>

        <span class="n">H_fit</span> <span class="o">=</span> <span class="n">A_fit</span> <span class="o">*</span> <span class="n">w0_fit</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1j</span> <span class="o">*</span> <span class="n">phi_fit</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w_vec</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">w_vec</span> <span class="o">*</span> <span class="n">w0_fit</span> <span class="o">/</span> <span class="n">Q_fit</span> <span class="o">-</span> <span class="n">w0_fit</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">resp_vec</span> <span class="o">-</span> <span class="n">H_fit</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1.2</span> <span class="ow">or</span> <span class="n">w0_fit</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">w_vec</span><span class="p">)</span> <span class="ow">or</span> <span class="n">w0_fit</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="n">w_vec</span><span class="p">):</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">sho_fast_guess</span><span class="p">(</span><span class="n">w_vec</span><span class="p">,</span> <span class="n">resp_vec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A_fit</span><span class="p">,</span> <span class="n">w0_fit</span><span class="p">,</span> <span class="n">Q_fit</span><span class="p">,</span> <span class="n">phi_fit</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">sho_fast_guess</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">,</span> <span class="n">w_vec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p0</span>


<span class="k">def</span> <span class="nf">sho_fast_guess</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">,</span> <span class="n">w_vec</span><span class="p">,</span> <span class="n">qual_factor</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Default SHO guess from the maximum value of the response</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    resp_vec : 1D complex numpy array or list</span>
<span class="sd">        BE response vector as a function of frequency</span>
<span class="sd">    w_vec : 1D numpy array or list</span>
<span class="sd">        Vector of BE frequencies</span>
<span class="sd">    qual_factor : float</span>
<span class="sd">        Quality factor of the SHO peak</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    retval : 1D numpy array</span>
<span class="sd">        SHO fit parameters arranged as [amplitude, frequency, quality factor, phase]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">amp_vec</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">)</span>
    <span class="n">i_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp_vec</span><span class="p">)</span> <span class="o">/</span> <span class="n">qual_factor</span><span class="p">,</span> <span class="n">w_vec</span><span class="p">[</span><span class="n">i_max</span><span class="p">],</span> <span class="n">qual_factor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">[</span><span class="n">i_max</span><span class="p">])])</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-the-function">
<h2>Testing the function<a class="headerlink" href="#testing-the-function" title="Permalink to this headline">¶</a></h2>
<p>Let’s see what the operation on an example spectra returns. The function essentially returns four parameters that can
capture the the shape of the spectra.</p>
<p>A single call to the function does not take substantial time. However, performing the same operation on each of the
16,384 pixels can take substantial time</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">19</span>
<span class="n">resp_vec</span> <span class="o">=</span> <span class="n">h5_main</span><span class="p">[</span><span class="n">col_ind</span> <span class="o">+</span> <span class="n">row_ind</span><span class="o">*</span><span class="n">num_cols</span><span class="p">]</span>
<span class="n">norm_guess_parms</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">be_sho</span><span class="o">.</span><span class="n">SHOestimateGuess</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">,</span> <span class="n">freq_vec</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Functional fit returned:&#39;</span><span class="p">,</span> <span class="n">norm_guess_parms</span><span class="p">)</span>
<span class="n">norm_resp</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">be_sho</span><span class="o">.</span><span class="n">SHOfunc</span><span class="p">(</span><span class="n">norm_guess_parms</span><span class="p">,</span> <span class="n">freq_vec</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Amplitude (a.u.)&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase (rad)&#39;</span><span class="p">]):</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">freq_vec</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_vec</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">norm_resp</span><span class="p">),</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Guess&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (kHz)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">))</span><span class="o">*</span><span class="mf">1.1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_tutorial_04_parallel_computing_0021.png" class="align-center" src="../_images/sphx_glr_plot_tutorial_04_parallel_computing_0021.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="n">Functional</span> <span class="n">fit</span> <span class="n">returned</span><span class="p">:</span> <span class="p">[</span>  <span class="mf">3.29443444e-04</span>   <span class="mf">3.66272704e+02</span>   <span class="mf">3.04426246e+01</span>   <span class="mf">1.58804069e+00</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="applying-the-function-to-the-entire-dataset">
<h2>Applying the function to the entire dataset<a class="headerlink" href="#applying-the-function-to-the-entire-dataset" title="Permalink to this headline">¶</a></h2>
<p>We will be comparing the:
1. Traditional - serial computation approach
2. Parallel computation</p>
<p>In an effort to avoid reading / writing to the data files, we will read the entire dataset to memory.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">h5_main</span><span class="p">[()]</span>

<span class="n">serial_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">raw_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="serial-computation">
<h3>1. Serial Computation<a class="headerlink" href="#serial-computation" title="Permalink to this headline">¶</a></h3>
<p>The simplest method to compute the paramters for each spectra in the dataset is by looping over each position using
a simple for loop.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">t_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">pix_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">serial_results</span><span class="p">[</span><span class="n">pix_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">be_sho</span><span class="o">.</span><span class="n">SHOestimateGuess</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">pix_ind</span><span class="p">],</span> <span class="n">freq_vec</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Serial computation took&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t_0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39; seconds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="n">Serial</span> <span class="n">computation</span> <span class="n">took</span> <span class="mf">41.32</span>  <span class="n">seconds</span>
</pre></div>
</div>
</div>
<div class="section" id="parallel-computation">
<h3>2. Parallel Computation<a class="headerlink" href="#parallel-computation" title="Permalink to this headline">¶</a></h3>
<p>There are several libraries that can utilize multiple CPU cores to perform the same computation in parallel. Popular
examples are <strong>Multiprocessing</strong>, <strong>Mutiprocess</strong>, <strong>Dask</strong>, <strong>Joblib</strong> etc. Each of these has their own
strengths and weaknesses. An installation of <strong>Anaconda</strong> comes with <strong>Multiprocessing</strong> by default and could be
the example of choice. However, in our experience we found <strong>Joblib</strong> to offer the best balance of efficiency,
simplicity, portabiity, and ease of installation.</p>
<p>For illustrative purposes, we will only be demonstrating how the above serial computation can be made parallel using
<strong>Joblib</strong>. We only need two lines to perform the parallel computation. The first line sets up the computational
jobs while the second performs the computation.</p>
<p>Note that the first argument to the function <strong>MUST</strong> be the data vector itself. The other arguments (parameters),
such as the frequency vector in this case, must come after the data argument. This approach allows the specification
of both required arguments and optional (keyword) arguments.</p>
<p>Parallel computing has been made more accessible via the parallel_compute() function in the <cite>process</cite> module in
pycroscopy. The below parallel computation is reduced to a single line with this function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">be_sho</span><span class="o">.</span><span class="n">SHOestimateGuess</span>
<span class="n">cores</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">freq_vec</span>

<span class="n">t_0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">]</span>
<span class="n">parallel_results</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">cores</span><span class="p">)(</span><span class="n">values</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel computation took&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t_0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39; seconds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="n">Parallel</span> <span class="n">computation</span> <span class="n">took</span> <span class="mf">39.77</span>  <span class="n">seconds</span>
</pre></div>
</div>
</div>
<div class="section" id="compare-the-results">
<h3>Compare the results<a class="headerlink" href="#compare-the-results" title="Permalink to this headline">¶</a></h3>
<p>By comparing the run-times for the two approaches, we see that the parallel computation is substantially faster than
the serial computation. Note that the numbers will differ between computers. Also, the computation was performed on
a relatively small dataset for illustrative purposes. The benefits of using such parallel computation will be far
more apparent for much larger datasets.</p>
<p>Let’s compare the results from both the serial and parallel methods to ensure they give the same results:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">19</span>
<span class="n">pix_ind</span> <span class="o">=</span> <span class="n">col_ind</span> <span class="o">+</span> <span class="n">row_ind</span> <span class="o">*</span> <span class="n">num_cols</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel and serial computation results matching:&#39;</span><span class="p">,</span>
      <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">serial_results</span><span class="p">[</span><span class="n">pix_ind</span><span class="p">],</span> <span class="n">parallel_results</span><span class="p">[</span><span class="n">pix_ind</span><span class="p">])))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="n">Parallel</span> <span class="ow">and</span> <span class="n">serial</span> <span class="n">computation</span> <span class="n">results</span> <span class="n">matching</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="best-practices-for-parallel-computing">
<h2>Best practices for parallel computing<a class="headerlink" href="#best-practices-for-parallel-computing" title="Permalink to this headline">¶</a></h2>
<p>While it may seem tempting to do everything in parallel, it is important to be aware of some of the trade-offs and
best-practices for parallel computing (multiple CPU cores) when compared to traditional serial computing (single
CPU core):
* There is noticable time overhead involved with setting up each parallel computing job. For very simple or small
computations, this overhead may outweigh the speed-up gained with using multiple cores.
* Parallelizing computations that read and write to files at each iteration may be actually be noticably __slower__
than serial computation since each core will compete with all other cores for rights to read and write to the file(s)
and these input/output operations are by far the slowest components of the computation. Instead, it makes sense to
read large amounts of data from the necessary files once, perform the computation, and then write to the files once
after all the computation is complete. In fact, this is what we automatically do in the <strong>Analysis</strong> and
<strong>Process</strong> class in <strong>pycroscopy</strong></p>
<div class="section" id="process-class-formalizing-data-processing">
<h3>Process class - Formalizing data processing<a class="headerlink" href="#process-class-formalizing-data-processing" title="Permalink to this headline">¶</a></h3>
<p>Data processing / analysis typically involves a few basic operations:
1. Reading data from file
2. Parallel computation
3. Writing results to disk</p>
<p>The Process class in pycroscopy aims to modularize these operations for faster development of standardized,
easy-to-debug code. Common operations can be inherited from this class and only the operation-specific functions
need to be extended in your class.
Please see another example on how to write a Process class for Pycroscopy</p>
<p><strong>Delete the temporarily downloaded file</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">h5_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h5_path</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 1 minutes  22.638 seconds)</p>
<div class="sphx-glr-footer docutils container">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_tutorial_04_parallel_computing1.py" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_tutorial_04_parallel_computing.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_tutorial_04_parallel_computing1.ipynb" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_tutorial_04_parallel_computing.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Suhas Somnath, Chris Smith, Stephen Jesse, Numan Laanait.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.59.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>