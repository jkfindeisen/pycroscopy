

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial 5: Formalizing Data Processing &mdash; pycroscopy 0.59.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="pycroscopy 0.59.2 documentation" href="../index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> pycroscopy
          

          
          </a>

          
            
            
              <div class="version">
                0.59.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">Pycroscopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">What’s New</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_format.html">Pycroscopy Data and File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../papers_conferences.html">Papers / Conferences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html">Examples &amp; Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html#scientific-data-analysis">Scientific Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html#developer-tutorials">Developer Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html#user-tutorials">User Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pycroscopy</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Tutorial 5: Formalizing Data Processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/auto_tutorials/plot_tutorial_05_data_processing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial-5-formalizing-data-processing">
<span id="sphx-glr-auto-tutorials-plot-tutorial-05-data-processing-py"></span><h1>Tutorial 5: Formalizing Data Processing<a class="headerlink" href="#tutorial-5-formalizing-data-processing" title="Permalink to this headline">¶</a></h1>
<p><strong>Suhas Somnath</strong></p>
<p>9/8/2017</p>
<p>This set of tutorials will serve as examples for developing end-to-end workflows for and using pycroscopy.</p>
<p><strong>In this example, we will learn how to write a simple yet formal pycroscopy class for processing data.</strong></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Data processing / analysis typically involves a few basic tasks:
1. Reading data from file
2. Computation
3. Writing results to disk</p>
<p>This example is based on the parallel computing example where we fit a dataset containing spectra at each location to a
function. While the previous example focused on comparing serial and parallel computing, we will focus on the framework
that needs to be built around a computation for robust data processing. As the example will show below, the framework
essentially deals with careful file reading and writing.</p>
<p>The majority of the code for this example is based on the BESHOModel Class under pycroscopy.analysis</p>
</div>
<div class="section" id="import-necessary-packages">
<h2>Import necessary packages<a class="headerlink" href="#import-necessary-packages" title="Permalink to this headline">¶</a></h2>
<p>Ensure python 3 compatibility:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="c1"># The package for accessing files in directories, etc.:</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Warning package in case something goes wrong</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="c1"># Package for downloading online files:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># This package is not part of anaconda and may need to be installed.</span>
    <span class="kn">import</span> <span class="nn">wget</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;wget not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;wget&#39;</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">wget</span>

<span class="c1"># The mathematical computation package:</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="nb">abs</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="n">imag</span><span class="p">,</span> <span class="n">arctan2</span><span class="p">,</span> <span class="n">append</span>

<span class="c1"># The package used for creating and manipulating HDF5 files:</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="c1"># Packages for plotting:</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="c1"># Finally import pycroscopy for certain scientific analysis:</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pycroscopy</span> <span class="kn">as</span> <span class="nn">px</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;pycroscopy not found.  Will install with pip.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="n">pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;pycroscopy&#39;</span><span class="p">])</span>
    <span class="kn">import</span> <span class="nn">pycroscopy</span> <span class="kn">as</span> <span class="nn">px</span>


<span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Amplitude [V]&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency [Hz]&#39;</span><span class="p">,</span> <span class="s1">&#39;Quality Factor&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase [rad]&#39;</span><span class="p">]</span>
<span class="n">sho32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">field_names</span><span class="p">,</span>
                  <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">]})</span>
</pre></div>
</div>
</div>
<div class="section" id="build-the-class">
<h2>Build the class<a class="headerlink" href="#build-the-class" title="Permalink to this headline">¶</a></h2>
<p>Every process class consists of the same basic functions:
1. __init__ - instantiates a ‘Process’ object of this class after validating the inputs
2. _create_results_datasets - creates the HDF5 datasets and datagroups to store the results.
3. _unit_function - this is the operation that will per be performed on each element in the dataset.
4. compute - This function essentially applies the unit function to every single element in the dataset.
5. _write_results_chunk - writes the computed results back to the file</p>
<p>Note that:</p>
<ul class="simple">
<li>Only the code specific to this process needs to be implemented. However, the generic portions common to most
Processes will be handled by the Process class.</li>
<li>The other functions such as the sho_function, sho_fast_guess function are all specific to this process. These have
been inherited directly from the BE SHO model.</li>
<li>While the class appears to be large, remember that the majority of it deals with the creation of the datasets to store
the results and the actual function that one would have anyway regardless of serial / parallel computation of the
function. The additional code to turn this operation into a Pycroscopy Process is actually rather minimal. As
described earlier, the goal of the Process class is to modularize and compartmentalize the main sections of the code
in order to facilitate faster and more robust implementation of data processing algorithms.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ShoGuess</span><span class="p">(</span><span class="n">px</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_main</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the inputs and set some parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_main - dataset to compute on</span>
<span class="sd">        cores - Number of CPU cores to use for computation - Optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ShoGuess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="n">cores</span><span class="p">)</span>

        <span class="c1"># find the frequency vector</span>
        <span class="n">h5_spec_vals</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getAuxData</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">h5_spec_vals</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1E-3</span>

    <span class="k">def</span> <span class="nf">_create_results_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the datasets an datagroups necessary to store the results.</span>
<span class="sd">        Just as the raw data is stored in the pycroscopy format, the results also need to conform to the same</span>
<span class="sd">        standards. Hence, the create_datasets function can appear to be a little longer than one might expect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5_spec_inds</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getAuxData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_main</span><span class="p">,</span> <span class="n">auxDataName</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Spectroscopic_Indices&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h5_spec_vals</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getAuxData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_main</span><span class="p">,</span> <span class="n">auxDataName</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_start_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">h5_spec_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_udvs_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_start_inds</span><span class="p">)</span>

        <span class="n">ds_guess</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">MicroDataset</span><span class="p">(</span><span class="s1">&#39;Guess&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[],</span>
                                             <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_main</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_udvs_steps</span><span class="p">),</span>
                                             <span class="n">chunking</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_udvs_steps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sho32</span><span class="p">)</span>

        <span class="n">not_freq</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">h5_spec_inds</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Frequency&#39;</span>

        <span class="n">ds_sho_inds</span><span class="p">,</span> <span class="n">ds_sho_vals</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">buildReducedSpec</span><span class="p">(</span><span class="n">h5_spec_inds</span><span class="p">,</span> <span class="n">h5_spec_vals</span><span class="p">,</span> <span class="n">not_freq</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">step_start_inds</span><span class="p">)</span>

        <span class="n">dset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_main</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sho_grp</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">MicroDataGroup</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">dset_name</span><span class="p">,</span> <span class="s1">&#39;SHO_Fit_&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_main</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">sho_grp</span><span class="o">.</span><span class="n">addChildren</span><span class="p">([</span><span class="n">ds_guess</span><span class="p">,</span> <span class="n">ds_sho_inds</span><span class="p">,</span> <span class="n">ds_sho_vals</span><span class="p">])</span>
        <span class="n">sho_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;SHO_guess_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pycroscopy BESHO&quot;</span>

        <span class="n">h5_sho_grp_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">writeData</span><span class="p">(</span><span class="n">sho_grp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5_guess</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getH5DsetRefs</span><span class="p">([</span><span class="s1">&#39;Guess&#39;</span><span class="p">],</span> <span class="n">h5_sho_grp_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_results_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_guess</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">h5_sho_inds</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getH5DsetRefs</span><span class="p">([</span><span class="s1">&#39;Spectroscopic_Indices&#39;</span><span class="p">],</span>
                                                 <span class="n">h5_sho_grp_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h5_sho_vals</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getH5DsetRefs</span><span class="p">([</span><span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">],</span>
                                                 <span class="n">h5_sho_grp_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Reference linking before actual fitting</span>
        <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">linkRefs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_guess</span><span class="p">,</span> <span class="p">[</span><span class="n">h5_sho_inds</span><span class="p">,</span> <span class="n">h5_sho_vals</span><span class="p">])</span>
        <span class="c1"># Linking ancillary position datasets:</span>
        <span class="n">aux_dsets</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getAuxData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_main</span><span class="p">,</span> <span class="n">auxDataName</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">,</span> <span class="s1">&#39;Position_Values&#39;</span><span class="p">])</span>
        <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">linkRefs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_guess</span><span class="p">,</span> <span class="n">aux_dsets</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Finshed creating datasets&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the unit_function to the entire dataset. Here, we simply extend the existing compute function and only</span>
<span class="sd">        pass the parameters for the unit function. In this case, the only parameter is the frequency vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ShoGuess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">w_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_vec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_results_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the computed results back to the H5 file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># converting from a list to a 2D numpy array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_guess</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">io_utils</span><span class="o">.</span><span class="n">realToCompound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span> <span class="n">sho32</span><span class="p">)</span>

        <span class="c1"># Now update the start position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_pos</span>
        <span class="c1"># this should stop the computation.</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_unit_function</span><span class="p">():</span>

        <span class="k">return</span> <span class="n">px</span><span class="o">.</span><span class="n">be_sho</span><span class="o">.</span><span class="n">SHOestimateGuess</span>
</pre></div>
</div>
</div>
<div class="section" id="load-the-dataset">
<h2>Load the dataset<a class="headerlink" href="#load-the-dataset" title="Permalink to this headline">¶</a></h2>
<p>For this example, we will be working with a Band Excitation Piezoresponse Force Microscopy (BE-PFM) imaging dataset
acquired from advanced atomic force microscopes. In this dataset, a spectra was collected for each position in a two
dimensional grid of spatial locations. Thus, this is a three dimensional dataset that has been flattened to a two
dimensional matrix in accordance with the pycroscopy data format.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># download the raw data file from Github:</span>
<span class="n">h5_path</span> <span class="o">=</span> <span class="s1">&#39;temp.h5&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/pycroscopy/pycroscopy/master/data/BELine_0004.h5&#39;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">h5_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h5_path</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">h5_path</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Open the file in read-only mode</span>
<span class="n">h5_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">h5_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>

<span class="c1"># Get handles to the the raw data along with other datasets and datagroups that contain necessary parameters</span>
<span class="n">h5_meas_grp</span> <span class="o">=</span> <span class="n">h5_file</span><span class="p">[</span><span class="s1">&#39;Measurement_000&#39;</span><span class="p">]</span>
<span class="n">num_rows</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">h5_meas_grp</span><span class="p">,</span> <span class="s1">&#39;grid_num_rows&#39;</span><span class="p">)</span>
<span class="n">num_cols</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="n">h5_meas_grp</span><span class="p">,</span> <span class="s1">&#39;grid_num_cols&#39;</span><span class="p">)</span>

<span class="c1"># Getting a reference to the main dataset:</span>
<span class="n">h5_main</span> <span class="o">=</span> <span class="n">h5_meas_grp</span><span class="p">[</span><span class="s1">&#39;Channel_000/Raw_Data&#39;</span><span class="p">]</span>

<span class="c1"># Extracting the X axis - vector of frequencies</span>
<span class="n">h5_spec_vals</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">hdf_utils</span><span class="o">.</span><span class="n">getAuxData</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">freq_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">h5_spec_vals</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1E-3</span>
</pre></div>
</div>
<p>Use the ShoGuess class, defined earlier, to calculate the four
parameters of the complex gaussian.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fitter</span> <span class="o">=</span> <span class="n">ShoGuess</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">h5_results_grp</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">h5_guess</span> <span class="o">=</span> <span class="n">h5_results_grp</span><span class="p">[</span><span class="s1">&#39;Guess&#39;</span><span class="p">]</span>

<span class="n">row_ind</span><span class="p">,</span> <span class="n">col_ind</span> <span class="o">=</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">19</span>
<span class="n">pix_ind</span> <span class="o">=</span> <span class="n">col_ind</span> <span class="o">+</span> <span class="n">row_ind</span> <span class="o">*</span> <span class="n">num_cols</span>
<span class="n">resp_vec</span> <span class="o">=</span> <span class="n">h5_main</span><span class="p">[</span><span class="n">pix_ind</span><span class="p">]</span>
<span class="n">norm_guess_parms</span> <span class="o">=</span> <span class="n">h5_guess</span><span class="p">[</span><span class="n">pix_ind</span><span class="p">]</span>

<span class="c1"># Converting from compound to real:</span>
<span class="n">norm_guess_parms</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">io_utils</span><span class="o">.</span><span class="n">compound_to_scalar</span><span class="p">(</span><span class="n">norm_guess_parms</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Functional fit returned:&#39;</span><span class="p">,</span> <span class="n">norm_guess_parms</span><span class="p">)</span>
<span class="n">norm_resp</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">be_sho</span><span class="o">.</span><span class="n">SHOfunc</span><span class="p">(</span><span class="n">norm_guess_parms</span><span class="p">,</span> <span class="n">freq_vec</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-default"><div class="highlight"><pre><span></span><span class="n">Finshed</span> <span class="n">creating</span> <span class="n">datasets</span>
<span class="n">Computing</span> <span class="n">serially</span> <span class="o">...</span>
<span class="n">Completed</span> <span class="n">computation</span> <span class="n">on</span> <span class="n">chunk</span><span class="o">.</span> <span class="n">Writing</span> <span class="n">to</span> <span class="n">file</span><span class="o">.</span>
<span class="n">Functional</span> <span class="n">fit</span> <span class="n">returned</span><span class="p">:</span> <span class="p">[</span>  <span class="mf">3.29443457e-04</span>   <span class="mf">3.66272705e+02</span>   <span class="mf">3.04426250e+01</span>   <span class="mf">1.58804071e+00</span><span class="p">]</span>
</pre></div>
</div>
<p>Plot the Amplitude and Phase of the gaussian versus the raw data.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Amplitude (a.u.)&#39;</span><span class="p">,</span> <span class="s1">&#39;Phase (rad)&#39;</span><span class="p">]):</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">freq_vec</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_vec</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">norm_resp</span><span class="p">),</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Guess&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (kHz)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resp_vec</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_tutorial_05_data_processing_0011.png" class="align-center" src="../_images/sphx_glr_plot_tutorial_05_data_processing_0011.png" />
<p><strong>Delete the temporarily downloaded file</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">h5_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">h5_path</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 0 minutes  40.505 seconds)</p>
<div class="sphx-glr-footer docutils container">
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_tutorial_05_data_processing1.py" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_tutorial_05_data_processing.py</span></code></a></div>
<div class="sphx-glr-download docutils container">
<a class="reference download internal" href="../_downloads/plot_tutorial_05_data_processing1.ipynb" download=""><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_tutorial_05_data_processing.ipynb</span></code></a></div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Suhas Somnath, Chris Smith, Stephen Jesse, Numan Laanait.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.59.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>